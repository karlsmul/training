<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Kreuzheben - Krafttrainings App</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Kreuzheben - Tracke deine Krafttrainings-Einheiten und pers√∂nlichen Bestleistungen">
    <meta name="theme-color" content="#1a0033">

    <!-- iOS Specific Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kreuzheben">
    <link rel="apple-touch-icon" href="icon.svg">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="icon.svg">

    <link rel="stylesheet" href="style.css?v=39">
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <img src="logo.png" alt="Kreuzheben Logo" class="app-logo">
            </div>
            <h1>KREUZHEBEN</h1> 

            <p class="date" id="currentDate"></p>

            <!-- Sync Status -->
            <div class="sync-container">
                <span id="syncIcon" class="sync-icon">üîì</span>
                <span id="syncStatus" class="sync-status not_logged_in">Anmelden f√ºr Cloud-Sync</span>
            </div>

            <!-- Manual Update Button -->
            <div class="update-container">
                <button id="updateButton" class="btn-update" title="Ansicht aktualisieren">
                    üîÑ Aktualisieren
                </button>
                <span id="updateIndicator" class="update-indicator" style="display: none;">Neue Daten verf√ºgbar</span>
            </div>

            <!-- User Info / Login Button -->
            <div id="userInfo" class="user-info">
                <button class="btn-login" id="loginButton">Anmelden f√ºr Cloud-Sync</button>
            </div>
        </header>

        <main>
            <section class="input-section">
                <h2 id="formTitle">Neues Training eintragen</h2>
                <form id="trainingForm">
                    <div class="form-group">
                        <label for="exercise">√úbung:</label>
                        <select id="exercise" required>
                            <option value="">-- √úbung ausw√§hlen --</option>
                            <!-- Wird dynamisch gef√ºllt -->
                        </select>
                    </div>

                    <!-- Toggle zwischen Gewicht und Zeit -->
                    <div class="form-group">
                        <label>Trainingsart:</label>
                        <div class="training-type-toggle">
                            <button type="button" class="toggle-btn active" data-type="weight">‚öñÔ∏è Gewicht</button>
                            <button type="button" class="toggle-btn" data-type="time">‚è±Ô∏è Zeit</button>
                        </div>
                    </div>

                    <!-- Gewicht Input -->
                    <div class="form-group" id="weightGroup">
                        <label for="weight">Gewicht (kg):</label>
                        <input type="number" id="weight" step="0.5" placeholder="z.B. 80">
                        <div class="form-checkbox">
                            <input type="checkbox" id="differentWeights">
                            <label for="differentWeights">Unterschiedliche Gewichte pro Satz</label>
                        </div>
                    </div>

                    <!-- Zeit Input (versteckt) -->
                    <div class="form-group" id="timeGroup" style="display: none;">
                        <label for="time">Zeit:</label>
                        <div class="time-input-group">
                            <input type="number" id="timeMinutes" min="0" placeholder="Min" style="width: 48%;">
                            <input type="number" id="timeSeconds" min="0" max="59" placeholder="Sek" style="width: 48%;">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="sets">Anzahl S√§tze:</label>
                        <input type="number" id="sets" min="1" max="10" value="4" required>
                    </div>

                    <!-- Wiederholungen pro Satz -->
                    <div class="form-group">
                        <label>Wiederholungen pro Satz:</label>
                        <div id="repsInputs" class="reps-inputs">
                            <!-- Dynamisch generiert -->
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="date">Datum:</label>
                        <input type="date" id="date" required>
                    </div>

                    <div class="form-buttons">
                        <button type="submit" class="btn-primary" id="submitBtn">Eintrag hinzuf√ºgen</button>
                        <button type="button" class="btn-cancel" id="cancelBtn" style="display: none;">Abbrechen</button>
                    </div>
                </form>
            </section>

            <section class="history-section">
                <!-- Tab Navigation -->
                <div class="tab-navigation">
                    <button class="tab-btn active" data-tab="history">üìä Historie</button>
                    <button class="tab-btn" data-tab="plan">üìã Plan</button>
                    <button class="tab-btn" data-tab="stats">üìà Auswertung</button>
                    <button class="tab-btn" data-tab="records">üèÜ PRs</button>
                    <button class="tab-btn" data-tab="settings">‚öôÔ∏è Einstellungen</button>
                </div>

                <!-- Training History Tab -->
                <div id="historyTab" class="tab-content active">
                    <div class="history-header">
                        <h2>Trainingshistorie</h2>
                        <button id="clearHistory" class="btn-secondary">Alle l√∂schen</button>
                    </div>

                    <div class="filter-section">
                        <input type="text" id="searchExercise" placeholder="√úbung suchen...">
                        <select id="historyDateSelect">
                            <!-- Wird dynamisch gef√ºllt -->
                        </select>
                    </div>

                    <div id="trainingList" class="training-list"></div>
                </div>

                <!-- Training Plan Tab - Einfache √úbungsdaten -->
                <div id="planTab" class="tab-content">
                    <div class="plan-header">
                        <h2>Trainingsplan</h2>
                        <p class="plan-subtitle">Gewichte, S√§tze und Wiederholungen pro √úbung</p>
                    </div>

                    <!-- Neuen Eintrag hinzuf√ºgen -->
                    <form id="planEntryForm" class="plan-entry-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="planExercise">√úbung</label>
                                <select id="planExercise" required>
                                    <option value="">-- √úbung w√§hlen --</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row three-col">
                            <div class="form-group">
                                <label for="planWeight">Gewicht (kg)</label>
                                <input type="number" id="planWeight" step="0.5" min="0" placeholder="z.B. 60">
                            </div>
                            <div class="form-group">
                                <label for="planSets">S√§tze</label>
                                <input type="number" id="planSets" min="1" placeholder="z.B. 3">
                            </div>
                            <div class="form-group">
                                <label for="planReps">Wdh.</label>
                                <input type="number" id="planReps" min="1" placeholder="z.B. 10">
                            </div>
                        </div>
                        <button type="submit" class="btn-primary">Speichern</button>
                    </form>

                    <!-- √úbung anzeigen -->
                    <div class="plan-view-section">
                        <div class="form-group">
                            <label for="planViewExercise">Eintr√§ge anzeigen f√ºr:</label>
                            <select id="planViewExercise">
                                <option value="">-- √úbung w√§hlen --</option>
                            </select>
                        </div>
                    </div>

                    <!-- Liste der Eintr√§ge (gefiltert) -->
                    <div id="planList" class="plan-list">
                        <!-- Wird dynamisch gef√ºllt -->
                    </div>
                </div>

                <!-- Personal Records Tab -->
                <div id="recordsTab" class="tab-content">
                    <div class="records-header">
                        <h2>Pers√∂nliche Bestleistungen</h2>
                        <p class="records-subtitle">Die Big 3 √úbungen</p>
                    </div>

                    <div id="recordsList" class="records-list">
                        <!-- Personal Records werden hier angezeigt -->
                    </div>
                </div>

                <!-- Statistics Tab -->
                <div id="statsTab" class="tab-content">
                    <div class="stats-header">
                        <h2>Auswertung & Statistiken</h2>
                    </div>

                    <!-- Trainingsh√§ufigkeit -->
                    <div class="stats-cards">
                        <div class="stat-card">
                            <div class="stat-icon">üìÖ</div>
                            <div class="stat-label">Trainingstage diesen Monat</div>
                            <div class="stat-value" id="monthlyTrainings">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üìä</div>
                            <div class="stat-label">Durchschnitt pro Monat</div>
                            <div class="stat-value" id="avgMonthlyTrainings">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üí™</div>
                            <div class="stat-label">Gesamt Trainingstage</div>
                            <div class="stat-value" id="totalTrainings">0</div>
                        </div>
                    </div>

                    <!-- K√∂rpergewicht Chart -->
                    <div class="chart-container">
                        <h3>K√∂rpergewicht-Entwicklung</h3>
                        <canvas id="bodyWeightChart"></canvas>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settingsTab" class="tab-content">
                    <div class="settings-header">
                        <h2>Einstellungen</h2>
                    </div>

                    <!-- √úbungsverwaltung -->
                    <div class="settings-section">
                        <h3>√úbungsverwaltung</h3>
                        <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px;">
                            Verwalte deine √úbungsliste f√ºr das Dropdown-Men√º
                        </p>

                        <form id="exerciseForm">
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label for="newExercise">Neue √úbung:</label>
                                    <input type="text" id="newExercise" placeholder="z.B. Bankdr√ºcken">
                                </div>
                                <div style="display: flex; align-items: flex-end;">
                                    <button type="submit" class="btn-primary">Hinzuf√ºgen</button>
                                </div>
                            </div>
                        </form>

                        <!-- Ausklappbare √úbungsliste -->
                        <details class="exercise-details">
                            <summary id="exerciseSummary">Gespeicherte √úbungen anzeigen (0)</summary>
                            <div id="exerciseList" class="exercise-list">
                                <!-- √úbungsliste wird hier angezeigt -->
                            </div>
                        </details>
                    </div>

                    <!-- K√∂rperdaten -->
                    <div class="settings-section">
                        <h3>K√∂rperdaten</h3>
                        <form id="bodyDataForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="bodyWeight">K√∂rpergewicht (kg):</label>
                                    <input type="number" id="bodyWeight" step="0.1" placeholder="z.B. 75.5">
                                </div>
                                <div class="form-group">
                                    <label for="bodyWeightDate">Datum:</label>
                                    <input type="date" id="bodyWeightDate" required>
                                </div>
                            </div>
                            <button type="submit" class="btn-primary">Gewicht hinzuf√ºgen</button>
                        </form>

                        <!-- Zielgewicht -->
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                            <div class="form-group">
                                <label for="targetWeight">Zielgewicht (kg):</label>
                                <input type="number" id="targetWeight" step="0.1" placeholder="Optional">
                                <button onclick="saveTargetWeight()" class="btn-primary" style="margin-top: 10px;">Zielgewicht speichern</button>
                            </div>
                        </div>

                        <!-- Gewichtshistorie ausgeblendet, Daten bleiben gespeichert -->
                        <div id="bodyWeightHistory" class="body-weight-history" style="display: none;">
                        </div>
                    </div>

                    <!-- Konto-Einstellungen (nur wenn angemeldet) -->
                    <div id="accountSettings" class="settings-section" style="display: none;">
                        <h3>Konto</h3>
                        <div id="accountInfo" style="margin-bottom: 15px;">
                            <p><strong>E-Mail:</strong> <span id="accountEmail">-</span></p>
                            <p><strong>Status:</strong> <span id="accountVerified">-</span></p>
                        </div>

                        <!-- Passwort √§ndern -->
                        <details class="password-change-details">
                            <summary>Passwort √§ndern</summary>
                            <form id="changePasswordForm" style="margin-top: 15px;">
                                <div class="form-group">
                                    <label for="currentPassword">Aktuelles Passwort:</label>
                                    <input type="password" id="currentPassword" required minlength="6" autocomplete="current-password">
                                </div>
                                <div class="form-group">
                                    <label for="newPassword">Neues Passwort:</label>
                                    <input type="password" id="newPassword" required minlength="6" autocomplete="new-password" placeholder="Mind. 6 Zeichen">
                                </div>
                                <div class="form-group">
                                    <label for="confirmNewPassword">Neues Passwort best√§tigen:</label>
                                    <input type="password" id="confirmNewPassword" required minlength="6" autocomplete="new-password">
                                </div>
                                <button type="submit" class="btn-primary">Passwort √§ndern</button>
                            </form>
                        </details>

                        <!-- Verifizierungs-E-Mail erneut senden -->
                        <div id="resendVerificationSection" style="margin-top: 15px; display: none;">
                            <button onclick="resendVerificationEmail()" class="btn-secondary">Verifizierungs-E-Mail erneut senden</button>
                        </div>
                    </div>

                </div>
            </section>
        </main>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="modal-close" id="modalClose">&times;</span>
            <h2>üîê Anmelden</h2>
            <p>Melde dich an, um deine Trainings in der Cloud zu synchronisieren</p>

            <button id="googleLoginButton" class="btn-google">
                <span class="google-icon">G</span>
                Mit Google anmelden
            </button>

            <div class="divider">
                <span>oder</span>
            </div>

            <form id="emailLoginForm">
                <div class="form-group">
                    <input type="email" id="loginEmail" placeholder="E-Mail" required autocomplete="email">
                </div>
                <div class="form-group">
                    <input type="password" id="loginPassword" placeholder="Passwort (mind. 6 Zeichen)" required autocomplete="current-password" minlength="6">
                </div>
                <button type="submit" class="btn-primary">Mit E-Mail anmelden</button>
            </form>

            <p class="modal-footer">
                Noch kein Konto? <a href="#" id="registerLink">Registrieren</a>
                <br>
                <a href="#" id="forgotPasswordLink">Passwort vergessen?</a>
            </p>
        </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Firebase Config & Sync -->
    <script src="firebase-config.js?v=39"></script>
    <script src="sync.js?v=39"></script>

    <!-- Big 3 Plan-Auswertung -->
    <script src="plan-analysis.js?v=39"></script>

    <!-- Main App -->
    <script src="app.js?v=39"></script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            // L√∂sche ALLE alten Caches beim Start
            window.addEventListener('load', async () => {
                try {
                    const cacheNames = await caches.keys();
                    console.log('Gefundene Caches:', cacheNames);
                    for (const cacheName of cacheNames) {
                        // L√∂sche alle alten Cache-Versionen (v1-v13)
                        if (cacheName !== 'krafttraining-v39') {
                            console.log('L√∂sche alten Cache:', cacheName);
                            await caches.delete(cacheName);
                        }
                    }
                } catch (error) {
                    console.error('Fehler beim L√∂schen alter Caches:', error);
                }

                // Service Worker registrieren
                navigator.serviceWorker.register('/service-worker.js?v=39')
                    .then(registration => {
                        console.log('Service Worker registriert:', registration);

                        // Force update sofort
                        registration.update();

                        // Pr√ºfe auf Updates alle 30 Sekunden
                        setInterval(() => {
                            registration.update();
                        }, 30000);

                        // Wenn ein Update wartet, aktiviere es sofort
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('Neuer Service Worker verf√ºgbar - Seite wird neu geladen');
                                    window.location.reload();
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('Service Worker Registrierung fehlgeschlagen:', error);
                    });
            });

            // Wenn der Controller sich √§ndert (neuer SW aktiv), lade die Seite neu
            let refreshing = false;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (!refreshing) {
                    refreshing = true;
                    console.log('Service Worker aktualisiert - Seite wird neu geladen');
                    window.location.reload();
                }
            });
        }
    </script>
</body>
</html>
